#include <REGX52.H>
#include "math.h"
#include "stdio.h"
#include "sys/led.h"
#include "sys/iic.h"


unsigned char BUF[8]=0; 						 //数据缓冲区
unsigned char last_x,last_y;
int last_angle=-10;
unsigned char code position[360][2]={{120,25},{119,25},{117,25},{116,25},{114,25},{113,25},{112,25},{110,26},{109,26},{107,26},{106,26},{105,26},{103,27},{102,27},{101,27},{99,28},{98,28},{97,28},{95,29},{94,29},{93,30},{91,30},{90,31},{89,31},{87,32},{86,32},{85,33},{84,34},{82,34},{81,35},{80,36},{79,36},{78,37},{76,38},{75,39},{74,39},{73,40},{72,41},{71,42},{70,43},{69,44},{68,45},{66,46},{65,46},{64,47},{63,48},{62,49},{61,50},{61,51},{60,53},{59,54},{58,55},{57,56},{56,57},{55,58},{54,59},{54,60},{53,61},{52,63},{51,64},{51,65},{50,66},{49,67},{49,69},{48,70},{47,71},{47,72},{46,74},{46,75},{45,76},{45,78},{44,79},{44,80},{43,82},{43,83},{43,84},{42,86},{42,87},{42,88},{41,90},{41,91},{41,92},{41,94},{41,95},{40,97},{40,98},{40,99},{40,101},{40,102},{40,104},{40,105},{40,106},{40,108},{40,109},{40,111},{40,112},{40,113},{41,115},{41,116},{41,118},{41,119},{41,120},{42,122},{42,123},{42,124},{43,126},{43,127},{43,128},{44,130},{44,131},{45,132},{45,134},{46,135},{46,136},{47,138},{47,139},{48,140},{49,141},{49,143},{50,144},{51,145},{51,146},{52,147},{53,149},{54,150},{54,151},{55,152},{56,153},{57,154},{58,155},{59,156},{60,157},{61,159},{61,160},{62,161},{63,162},{64,163},{65,164},{66,164},{68,165},{69,166},{70,167},{71,168},{72,169},{73,170},{74,171},{75,171},{76,172},{78,173},{79,174},{80,174},{81,175},{82,176},{84,176},{85,177},{86,178},{87,178},{89,179},{90,179},{91,180},{93,180},{94,181},{95,181},{97,182},{98,182},{99,182},{101,183},{102,183},{103,183},{105,184},{106,184},{107,184},{109,184},{110,184},{112,185},{113,185},{114,185},{116,185},{117,185},{119,185},{120,185},{121,185},{123,185},{124,185},{126,185},{127,185},{128,185},{130,184},{131,184},{133,184},{134,184},{135,184},{137,183},{138,183},{139,183},{141,182},{142,182},{143,182},{145,181},{146,181},{147,180},{149,180},{150,179},{151,179},{153,178},{154,178},{155,177},{156,176},{158,176},{159,175},{160,174},{161,174},{162,173},{164,172},{165,171},{166,171},{167,170},{168,169},{169,168},{170,167},{171,166},{172,165},{174,164},{175,164},{176,163},{177,162},{178,161},{179,160},{179,159},{180,157},{181,156},{182,155},{183,154},{184,153},{185,152},{186,151},{186,150},{187,149},{188,147},{189,146},{189,145},{190,144},{191,143},{191,141},{192,140},{193,139},{193,138},{194,136},{194,135},{195,134},{195,132},{196,131},{196,130},{197,128},{197,127},{197,126},{198,124},{198,123},{198,122},{199,120},{199,119},{199,118},{199,116},{199,115},{200,113},{200,112},{200,111},{200,109},{200,108},{200,106},{200,105},{200,104},{200,102},{200,101},{200,99},{200,98},{200,97},{199,95},{199,94},{199,92},{199,91},{199,90},{198,88},{198,87},{198,86},{197,84},{197,83},{197,82},{196,80},{196,79},{195,78},{195,76},{194,75},{194,74},{193,72},{193,71},{192,70},{191,69},{191,67},{190,66},{189,65},{189,64},{188,63},{187,61},{186,60},{186,59},{185,58},{184,57},{183,56},{182,55},{181,54},{180,53},{179,51},{179,50},{178,49},{177,48},{176,47},{175,46},{174,46},{172,45},{171,44},{170,43},{169,42},{168,41},{167,40},{166,39},{165,39},{164,38},{162,37},{161,36},{160,36},{159,35},{158,34},{156,34},{155,33},{154,32},{153,32},{151,31},{150,31},{149,30},{147,30},{146,29},{145,29},{143,28},{142,28},{141,28},{139,27},{138,27},{137,27},{135,26},{134,26},{133,26},{131,26},{130,26},{128,25},{127,25},{126,25},{124,25},{123,25},{121,25}};


//通过地磁场在水平面方向X，Y计算相对于地理北极的角度
void get_direction(angle){
	 unsigned int t;
			LCD_Fill(64,93,184,117,BLACK);   //清空
		if((angle < 22.5) || (angle > 337.5 )){
			if(angle>=100){
				LCD_ShowNum(78,93,angle,3); 
				LCD_ShowFontHZ(114,93,"°北");
			}
			else{
				LCD_ShowNum(84,93,angle,2); 
				LCD_ShowFontHZ(108,93,"°北");
			}
		}	
		if((angle > 22.5) && (angle < 67.5 )){
			LCD_ShowNum(72,93,angle,2); 
			LCD_ShowFontHZ(96,93,"°东北");
		}
		if((angle > 67.5) && (angle < 112.5 )){
			if(angle>=100){
				LCD_ShowNum(78,93,angle,3); 
				LCD_ShowFontHZ(114,93,"°东");
			}else{
				LCD_ShowNum(84,93,angle,2); 
				LCD_ShowFontHZ(108,93,"°东");
			}
		}
		if((angle > 112.5) && (angle < 157.5 )){
				LCD_ShowNum(66,93,angle,3); 
				LCD_ShowFontHZ(102,93,"°东南");
		}
		if((angle > 157.5) && (angle < 202.5 )){
				LCD_ShowNum(78,93,angle,3); 
				LCD_ShowFontHZ(114,93,"°南");
		}
		if((angle > 202.5) && (angle < 247.5 )){
				LCD_ShowNum(66,93,angle,3); 
				LCD_ShowFontHZ(102,93,"°西南");
		}
		if((angle > 247.5) && (angle < 292.5 )){
			LCD_ShowNum(78,93,angle,3); 
				LCD_ShowFontHZ(114,93,"°西");
		}
		
		if((angle > 292.5) && (angle < 337.5 )){
			LCD_ShowNum(66,93,angle,3); 
				LCD_ShowFontHZ(102,93,"°西北");
		}
	//显示动态指针
		LCD_Fill(last_x-5,last_y-5,last_x+5,last_y+5,BLACK);   //清空
		//t=angle*3.14/180;
		t=angle%360;
		last_x=position[t][0];
		last_y=position[t][1];
//		last_y=cos(t)*80;
//		last_y=105-last_y;
//		last_x=sin(t)*80;
//		last_x=120-last_x;
		
		LCD_DrawPoint(last_x,last_y,RED);//画点 
		LCD_DrawPoint(last_x-1,last_y-1,RED);//画点 
		LCD_DrawPoint(last_x+1,last_y-1,RED);//画点 
		LCD_DrawPoint(last_x-1,last_y+1,RED);//画点 
		LCD_DrawPoint(last_x+1,last_y+1,RED);//画点 
		Draw_Circle(last_x,last_y,1,RED);
		Draw_Circle(last_x,last_y,2,RED);
		Draw_Circle(last_x,last_y,3,RED);
		Draw_Circle(last_x,last_y,4,RED);
		Draw_Circle(last_x,last_y,5,RED);
		
}
void main(){
	int X=0,Y=0,Z=0;
	double Angle_XY=0;
	//液晶屏初始化
	LCD_Init();
	LCD_Clear(0x0000);
	Init_QMC5883();
	//画圆
	Draw_Circle(120,105,90,WHITE);
	Draw_Circle(120,105,89,WHITE);
	//画标志位
	LCD_DrawLine(120,15,113,3,WHITE);
	LCD_DrawLine(120,15,127,3,WHITE);
	LCD_DrawLine(113,3,127,3,WHITE);
	LCD_DrawLine(113,4,127,4,WHITE);
	LCD_DrawLine(114,5,126,5,WHITE);
	LCD_DrawLine(114,6,126,6,WHITE);
	LCD_DrawLine(115,7,125,7,WHITE);
	LCD_DrawLine(115,8,125,8,WHITE);
	LCD_DrawLine(116,9,124,9,WHITE);
	LCD_DrawLine(116,10,124,10,WHITE);
	LCD_DrawLine(117,11,123,11,WHITE);
	LCD_DrawLine(118,12,122,12,WHITE);
	LCD_DrawLine(118,13,122,13,WHITE);
	LCD_DrawLine(119,14,121,14,WHITE);
	LCD_DrawPoint(120,15,WHITE);//画点 
	//循环进行各项测试	
	while(1)
	{	
			Multiple_Read_QMC5883();      				//连续读取三轴角度数据，存储在BUF中
				//---------显示XY轴
				X=BUF[1] << 8 | BUF[0]; //Combine MSB and LSB of X Data output register  最高有效位
				Y=BUF[3] << 8 | BUF[2]; //Combine MSB and LSB of Y Data output register
			//	Z=BUF[5] << 8 | BUF[4]; //Combine MSB and LSB of Z Data output register
				
				if(X>0x7fff)X-=0xffff;	  
				if(Y>0x7fff)Y-=0xffff;
				//if(Z>0x7fff)Z-=0xffff; 

				Angle_XY= atan2((double)Y,(double)X)* (180 / 3.14159265) + 180; //计算XY平面角度;	 
				

				if(abs((int)Angle_XY-last_angle)>2){
					get_direction(Angle_XY);       //计算XY平面角度数据和显示
					last_angle=(int)Angle_XY;
				}
				
	}   
}

